<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar {{ materia.nombre }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Styling Django form elements */
      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #d1d5db; /* gray-300 */
        margin-bottom: 0.5rem;
        margin-top: 1rem;
      }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      select {
        width: 100%;
        background-color: #374151; /* gray-700 */
        border: 1px solid #4b5563; /* gray-600 */
        color: #f3f4f6; /* gray-100 */
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        height: 2.75rem; /* Force consistent height */
      }
      textarea {
        width: 100%;
        background-color: #374151; /* gray-700 */
        border: 1px solid #4b5563; /* gray-600 */
        color: #f3f4f6; /* gray-100 */
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #6366f1; /* indigo-500 */
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      }
      .helptext {
        display: block;
        font-size: 0.75rem;
        color: #9ca3af; /* gray-400 */
        margin-bottom: 0.5rem;
      }
      ul.errorlist {
        color: #ef4444; /* red-500 */
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        list-style-type: disc;
        padding-left: 1.25rem;
      }
      /* Checkbox styling tweak */
      input[type="checkbox"] {
        margin-right: 0.5rem;
        border-radius: 0.25rem;
        background-color: #374151;
        border-color: #4b5563;
      }
      @keyframes slideInFadeOut {
        0% {
          opacity: 0;
          transform: translateY(-20px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        80% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-20px);
          pointer-events: none;
        }
      }
      .animate-toast {
        animation: slideInFadeOut 5s ease-in-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 font-sans">
    <div class="min-h-screen flex flex-col">
      <!-- 1. BARRA DE NAVEGACI√ìN -->
      <nav class="bg-gray-800 shadow-sm border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16 items-center">
            <div class="flex-shrink-0 flex items-center">
              <span class="text-2xl font-bold text-indigo-400"
                >üéì University Tracker</span
              >
            </div>
            <div class="flex items-center space-x-4">
              <span class="text-sm text-gray-400">
                Usuario:
                <strong class="text-gray-200">{{ user.username }}</strong>
              </span>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-grow container mx-auto px-4 py-10 max-w-6xl">
        <!-- Toast Container -->
        {% if messages %}
        <div class="fixed top-5 right-5 z-50 flex flex-col gap-3">
          {% for message in messages %}
          <div
            class="animate-toast px-6 py-4 rounded-lg shadow-lg text-white font-medium flex items-center gap-3 min-w-[300px] {% if message.tags == 'error' %}bg-red-500{% elif message.tags == 'success' %}bg-green-500{% elif message.tags == 'warning' %}bg-yellow-500{% else %}bg-blue-500{% endif %}"
          >
            {% if message.tags == 'success' %}
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            {% elif message.tags == 'error' %}
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
            {% else %}
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            {% endif %}

            <span>{{ message }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="mb-8 flex justify-between items-center">
          <h1 class="text-3xl font-bold text-white">
            Editando <span class="text-indigo-400">{{ materia.nombre }}</span>
          </h1>
          <a
            href="{% url 'home' %}"
            class="inline-flex items-center px-4 py-2 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-300 bg-gray-800 hover:bg-gray-700 hover:text-white transition-colors duration-200"
          >
            ‚Üê Volver
          </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- COLUMNA IZQUIERDA: DATOS DE LA MATERIA -->
          <div class="lg:col-span-2">
            <div
              class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden"
            >
              <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50">
                <h2 class="text-xl font-bold text-white">
                  ‚úèÔ∏è Datos Principales
                </h2>
              </div>
              <div class="p-6">
                <form method="post">
                  {% csrf_token %} {{ form.as_p }}
                  <div class="mt-6">
                    <button
                      type="submit"
                      class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200"
                    >
                      Guardar Cambios
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- COLUMNA DERECHA: LISTA DE NOTAS -->
          <div class="lg:col-span-1">
            <div
              class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden"
            >
              <div
                class="px-6 py-4 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center"
              >
                <h2 class="text-xl font-bold text-white">üìù Notas</h2>
                <a
                  href="{% url 'agregar_evaluacion' materia.id %}"
                  class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  + Nueva
                </a>
              </div>
              <div class="p-0">
                {% if evaluaciones %}
                <table class="min-w-full divide-y divide-gray-700">
                  <thead class="bg-gray-900/50">
                    <tr>
                      <th
                        scope="col"
                        class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                      >
                        Instancia
                      </th>
                      <th
                        scope="col"
                        class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider"
                      >
                        Fecha
                      </th>
                      <th
                        scope="col"
                        class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider"
                      >
                        Nota
                      </th>
                      <th scope="col" class="relative px-4 py-3">
                        <span class="sr-only">Acciones</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-gray-800 divide-y divide-gray-700">
                    {% for eval in evaluaciones %}
                    <tr class="hover:bg-gray-700/50 transition-colors">
                      <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-white">
                          {{ eval.get_instancia_display }}
                        </div>
                        <div class="text-xs text-gray-500">
                          {{ eval.get_tipo_contenido_display }}
                        </div>
                      </td>
                      <td
                        class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-300"
                      >
                        {{ eval.fecha|date:"d/m/Y"|default:"-" }}
                      </td>
                      <td
                        class="px-4 py-3 whitespace-nowrap text-center text-sm font-bold text-indigo-300"
                      >
                        {{ eval.nota|default:"-" }}
                      </td>
                      <td
                        class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium"
                      >
                        <a
                          href="{% url 'borrar_evaluacion' eval.id %}"
                          class="text-red-400 hover:text-red-300 transition-colors"
                          title="Eliminar nota"
                          onclick="deleteEvaluacion(event, this.href, this)"
                        >
                          <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            ></path>
                          </svg>
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <div class="p-6 text-center">
                  <p class="text-gray-500 text-sm italic">
                    No hay notas cargadas a√∫n.
                  </p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      function deleteEvaluacion(event, url, element) {
        event.preventDefault();

        fetch(url, {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Eliminar la fila de la tabla
              const row = element.closest("tr");
              row.remove();
            } else {
              alert("Error al eliminar la nota.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Ocurri√≥ un error al intentar eliminar la nota.");
          });
      }
    </script>
  </body>
</html>
